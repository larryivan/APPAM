# 测序数据质量控制指南

## 概述

质量控制是生物信息学分析流程中的关键步骤，确保后续分析的准确性和可靠性。本指南涵盖了高通量测序数据质量评估和质量控制的最佳实践。

## 质量控制的重要性

### 为什么需要质量控制
- 识别技术问题和实验偏差
- 确保数据质量满足分析要求
- 避免错误的生物学结论
- 优化后续分析参数

### 质量控制的时机
1. **原始数据质量评估**
2. **预处理后质量检查**
3. **比对后质量验证**
4. **最终结果质量控制**

## 原始数据质量评估

### FastQC分析

#### 基本使用
```bash
# 单个文件分析
fastqc sample.fastq.gz -o output_dir/

# 批量分析
fastqc *.fastq.gz -o output_dir/

# 设置线程数
fastqc -t 4 sample.fastq.gz -o output_dir/
```

#### 关键质量指标

##### 1. 每个位置的碱基质量
- **优秀**：所有位置质量分数 > 28
- **良好**：大部分位置质量分数 > 20
- **需要关注**：末端质量明显下降

##### 2. 每个序列的质量分数
- **优秀**：大部分序列平均质量 > 27
- **良好**：平均质量 > 20
- **需要关注**：出现双峰分布

##### 3. 每个位置的碱基含量
- **优秀**：A、T、G、C含量稳定
- **需要关注**：开始位置有偏差（adapter污染）
- **警告**：整体GC含量异常

##### 4. GC含量分布
```bash
# 理论GC含量（人类基因组）
# 正常范围：40-45%
# 异常情况：
# - 多个峰：样本混合
# - 偏移：contamination
```

##### 5. 序列长度分布
- **优秀**：长度一致
- **需要关注**：长度分布不均
- **警告**：过度修剪

##### 6. 重复序列水平
- **优秀**：重复序列 < 20%
- **需要关注**：重复序列 20-50%
- **警告**：重复序列 > 50%

### MultiQC汇总分析

#### 基本使用
```bash
# 汇总FastQC结果
multiqc fastqc_output/ -o multiqc_report/

# 包含多种工具结果
multiqc . -o multiqc_report/

# 自定义报告标题
multiqc . -o multiqc_report/ --title "Project Quality Report"
```

#### 重要图表解读
- **General Statistics**：样本概览
- **FastQC Summary**：质量控制通过/失败统计
- **Sequence Quality**：质量分数趋势
- **GC Content**：GC含量分布比较

## 数据预处理

### 接头去除和质量修剪

#### Trimmomatic使用
```bash
# 单端测序
trimmomatic SE -phred33 input.fastq.gz output.fastq.gz \
  ILLUMINACLIP:TruSeq3-SE.fa:2:30:10 \
  LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:36

# 双端测序
trimmomatic PE -phred33 input_R1.fastq.gz input_R2.fastq.gz \
  output_R1_paired.fastq.gz output_R1_unpaired.fastq.gz \
  output_R2_paired.fastq.gz output_R2_unpaired.fastq.gz \
  ILLUMINACLIP:TruSeq3-PE.fa:2:30:10:2:True \
  LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:36
```

#### 参数解释
- **ILLUMINACLIP**：去除接头序列
- **LEADING**：去除开头低质量碱基
- **TRAILING**：去除结尾低质量碱基
- **SLIDINGWINDOW**：滑动窗口修剪
- **MINLEN**：最小序列长度

#### fastp使用（更快的替代方案）
```bash
# 自动检测接头
fastp -i input.fastq.gz -o output.fastq.gz

# 双端测序
fastp -i input_R1.fastq.gz -I input_R2.fastq.gz \
  -o output_R1.fastq.gz -O output_R2.fastq.gz

# 自定义参数
fastp -i input.fastq.gz -o output.fastq.gz \
  --qualified_quality_phred 15 \
  --unqualified_percent_limit 40 \
  --length_required 36
```

### 污染序列去除

#### rRNA去除
```bash
# 使用SortMeRNA
sortmerna --ref silva-bac-16s-id90.fasta \
  --reads input.fastq.gz --aligned rRNA_aligned \
  --other clean_reads --fastx

# 使用Bowtie2
bowtie2 -x rRNA_index -U input.fastq.gz \
  --un clean_reads.fastq.gz -S /dev/null
```

#### 宿主DNA去除（宏基因组）
```bash
# 使用Bowtie2去除人类DNA
bowtie2 -x human_genome_index -U input.fastq.gz \
  --un non_human_reads.fastq.gz -S /dev/null
```

## 比对质量控制

### 比对统计
```bash
# 使用samtools stats
samtools stats aligned.bam > alignment_stats.txt

# 使用picard CollectAlignmentSummaryMetrics
picard CollectAlignmentSummaryMetrics \
  I=aligned.bam O=alignment_metrics.txt \
  R=reference.fasta
```

### 关键指标
- **总reads数**：原始数据量
- **比对率**：成功比对的reads比例
- **唯一比对率**：唯一比对的reads比例
- **多重比对率**：多个位置比对的reads比例

### 质量阈值
```bash
# 过滤低质量比对
samtools view -q 20 -b aligned.bam > filtered.bam

# 去除PCR重复
picard MarkDuplicates I=aligned.bam O=dedup.bam \
  M=dup_metrics.txt REMOVE_DUPLICATES=true
```

## RNA-seq特异性质量控制

### 基因覆盖度分析
```bash
# 使用RSeQC
geneBody_coverage.py -i aligned.bam -r genes.bed \
  -o sample_coverage
```

### 链特异性检查
```bash
# 使用RSeQC
infer_experiment.py -i aligned.bam -r genes.bed
```

### 饱和度分析
```bash
# 读取饱和度曲线
RPKM_saturation.py -i aligned.bam -r genes.bed \
  -o saturation_curve
```

## 质量控制标准

### DNA-seq质量标准
- **原始数据**：Q20 > 90%, Q30 > 85%
- **比对率**：> 90%
- **重复率**：< 20%
- **覆盖度**：均匀分布

### RNA-seq质量标准
- **原始数据**：Q20 > 90%, Q30 > 85%
- **比对率**：> 80%
- **基因检测**：> 15,000个基因（人类）
- **rRNA比例**：< 10%

### ChIP-seq质量标准
- **比对率**：> 70%
- **重复率**：< 25%
- **信号富集**：明显的peak信号
- **背景噪声**：低水平

## 批次效应检测

### 主成分分析（PCA）
```r
# 使用R进行PCA分析
library(prcomp)
pca_result <- prcomp(t(expression_matrix), scale=TRUE)
plot(pca_result$x[,1], pca_result$x[,2], 
     col=batch_colors, pch=19)
```

### 相关性分析
```r
# 样本间相关性
cor_matrix <- cor(expression_matrix)
pheatmap(cor_matrix, clustering_distance_rows="correlation",
         clustering_distance_cols="correlation")
```

## 自动化质量控制流程

### 脚本示例
```bash
#!/bin/bash
# 自动化质量控制流程

# 1. 原始数据质量评估
fastqc *.fastq.gz -o fastqc_output/

# 2. 数据预处理
for sample in *.fastq.gz; do
    base=$(basename $sample .fastq.gz)
    trimmomatic SE -phred33 $sample ${base}_trimmed.fastq.gz \
        ILLUMINACLIP:TruSeq3-SE.fa:2:30:10 \
        LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:36
done

# 3. 预处理后质量检查
fastqc *_trimmed.fastq.gz -o fastqc_trimmed/

# 4. 汇总报告
multiqc . -o final_report/
```

### Snakemake流程
```python
rule all:
    input:
        "multiqc_report/multiqc_report.html"

rule fastqc:
    input:
        "data/{sample}.fastq.gz"
    output:
        "fastqc/{sample}_fastqc.html"
    shell:
        "fastqc {input} -o fastqc/"

rule trimmomatic:
    input:
        "data/{sample}.fastq.gz"
    output:
        "trimmed/{sample}_trimmed.fastq.gz"
    shell:
        "trimmomatic SE -phred33 {input} {output} "
        "ILLUMINACLIP:TruSeq3-SE.fa:2:30:10 "
        "LEADING:3 TRAILING:3 SLIDINGWINDOW:4:15 MINLEN:36"

rule multiqc:
    input:
        expand("fastqc/{sample}_fastqc.html", sample=SAMPLES)
    output:
        "multiqc_report/multiqc_report.html"
    shell:
        "multiqc . -o multiqc_report/"
```

## 质量控制报告

### 报告内容
1. **数据概览**：样本信息、数据量统计
2. **质量评估**：各项质量指标结果
3. **预处理效果**：处理前后质量比较
4. **问题识别**：发现的问题和建议
5. **后续建议**：分析参数推荐

### 报告模板
```markdown
# 质量控制报告

## 样本信息
- 项目名称：XXX
- 样本数量：XXX
- 测序平台：XXX

## 质量评估结果
- 平均质量分数：XXX
- 比对率：XXX
- 检测基因数：XXX

## 发现的问题
1. 样本A质量较低，建议重新测序
2. 样本B存在adapter污染，已处理

## 建议
- 后续分析使用严格的质量过滤
- 注意批次效应的影响
```

## 常见问题与解决方案

### 1. 质量分数低
**原因**：测序仪器问题、试剂问题
**解决**：重新测序、调整参数

### 2. 接头污染
**原因**：接头去除不完全
**解决**：使用更严格的接头去除参数

### 3. GC含量异常
**原因**：样本污染、PCR偏差
**解决**：检查样本来源、优化PCR条件

### 4. 重复序列过多
**原因**：PCR过度扩增、文库复杂度低
**解决**：优化PCR循环数、增加起始材料

### 5. 比对率低
**原因**：参考基因组不匹配、质量差
**解决**：检查参考基因组、提高质量标准

## 工具对比

| 工具 | 速度 | 功能 | 易用性 | 推荐场景 |
|------|------|------|--------|----------|
| FastQC | 中等 | 基础质量评估 | 简单 | 标准质量检查 |
| MultiQC | 快速 | 结果汇总 | 简单 | 批量样本报告 |
| fastp | 快速 | 质量控制+预处理 | 简单 | 一体化处理 |
| Trimmomatic | 中等 | 专业预处理 | 中等 | 精细化处理 |
| RSeQC | 中等 | RNA-seq专用 | 中等 | RNA-seq分析 |

## 最佳实践

1. **标准化流程**：建立统一的质量控制标准
2. **自动化处理**：使用脚本或工作流管理系统
3. **详细记录**：保存所有质量控制参数和结果
4. **持续监控**：定期检查质量控制效果
5. **团队培训**：确保所有人员了解质量控制流程 